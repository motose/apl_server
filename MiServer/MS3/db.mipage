:Class db : MiPage

    addrValue ← ''
    zipValue  ← ''

    ∇ Compose;css;btn1;btn2
      :Access Public

      Add '<link rel="icon" href="https://www.dyalog.com/uploads/images/Business/products/product-icon.png">'

      ⍝ --- CSS ---
      css ← 'body { margin:0; font-family:sans-serif; background:#f0f2f5; }'
      css ,← '.header { background:#1a1a1a; color:white; height:72px; display:flex; align-items:center; justify-content:space-between; padding:0 24px; }'
      css ,← '.title { font-size:26px; font-weight:bold; }'
      css ,← '.orange { color:#ff9800; }'
      css ,← '.container { max-width:1000px; margin:0 auto; padding:40px; }'
      css ,← '.search-row { display:flex; gap:20px; margin-bottom:20px; }'
      css ,← '.action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: bold; cursor: pointer; color: white; border: none; transition: 0.2s; }' 
      css ,← '.action-btn:hover { opacity: 0.8; background:rgba(255,255,255,0.2); }' 
      css ,← '.card { background:white; padding:24px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); flex:1; }'
      css ,← '.search-btn { width:100%; padding:12px; background:#ff9800 !important; color:white !important; border:none; border-radius:4px; font-weight:bold; cursor:pointer; margin-top:10px; }'
      css ,← 'input[type="text"] { width:100%; box-sizing:border-box; padding:10px; border:1px solid #ddd; border-radius:4px; }'
      Add _.style css

      Add '<script>'
      Add 'function openMap(a){window.open("https://www.google.com/maps/search/"+encodeURIComponent(a),"_blank");}'
      Add 'function askAI(a){window.open("https://chatgpt.com/?q="+encodeURIComponent(a+" について詳しく教えて"), "_blank");}'
      Add '</script>'

      ⍝ --- Header (ロゴを修正) ---
      Add '<div class="header">'
      Add '<div style="display:flex;align-items:center;">'
      Add '<img src="https://www.dyalog.com/uploads/images/Business/products/product-icon.png" style="height:42px;margin-right:12px;">'
      Add '<div class="title"><span class="orange">Dyalog APL MiServer 3</span> サービス</div>'
      Add '</div>'
      Add '<div style="display:flex;align-items:center;">'
      Add '  <a href="https://ja.wikipedia.org/wiki/APL" target="_blank" class="action-btn info-btn">Info</a>' 
      Add '  <a href="/docs/readme.html" class="action-btn readme-btn">ReadMe</a>' 
      Add '<img src="https://sv1.etech21.net/assets/eTech21.png" style="height:36px;margin-right:10px;">'
      Add '<span style="font-size:20px;color:#ccc;">e-Tech21.net</span>'
      Add '</div>'
      Add '</div>'

      ⍝ --- Main UI ---
      Add '<div class="container">'
      Add '<div class="search-row">'

      ⍝ 住所検索
      Add '<div class="card">'
      Add '<h2>住所検索</h2>'
      'addr' Add _.Input 'text' '' '住所の一部'
      btn1 ← Add _.Button '住所検索'
      btn1.id ← 'btnAddr'
      btn1.Set 'class' 'search-btn'
      Add '</div>'

      ⍝ 郵便番号検索
      Add '<div class="card">'
      Add '<h2>郵便番号検索</h2>'
      'zip' Add _.Input 'text' '' '例:3380001'
      btn2 ← Add _.Button '郵便番号検索'
      btn2.id ← 'btnZip'
      btn2.Set 'class' 'search-btn'
      Add '</div>'

      Add '</div>'

      Add '<div class="card">'
      Add '<h2>検索結果</h2>'
      'out' Add _.div 'ここに結果が出ます'
      Add '</div>'
      Add '</div>'

      ⍝ --- Events ---
      Add _.Handler 'input' 'change' 'OnInput'
      Add _.Handler '#btnAddr' 'click' 'RunAddrSQL'
      Add _.Handler '#btnZip' 'click' 'RunZipSQL'
    ∇

    ∇ r←OnInput
      :Access Public
      :If _what ≡ 'addr' ⋄ addrValue ← _value
      :ElseIf _what ≡ 'zip' ⋄ zipValue ← _value
      :EndIf
      r ← 0
    ∇

    ∇ r←RunAddrSQL;sql;cond
      :Access Public
      cond ← '%',addrValue,'%'
      sql ← 'SELECT zipcode,prefectures,city,town FROM zipcode '
      sql ,← 'WHERE prefectures LIKE "',cond,'" OR city LIKE "',cond,'" OR town LIKE "',cond,'" '
      sql ,← 'LIMIT 20 INTO OUTFILE "/var/lib/mysql-files/coco/zipcode.csv" '
      sql ,← 'FIELDS TERMINATED BY "," ENCLOSED BY "\"" LINES TERMINATED BY "\n";'
      r ← ExecSQL sql
    ∇

    ∇ r←RunZipSQL;sql
      :Access Public
      sql ← 'SELECT zipcode,prefectures,city,town FROM zipcode '
      sql ,← 'WHERE zipcode LIKE "',zipValue,'%" '
      sql ,← 'LIMIT 20 INTO OUTFILE "/var/lib/mysql-files/coco/zipcode.csv" '
      sql ,← 'FIELDS TERMINATED BY "," ENCLOSED BY "\"" LINES TERMINATED BY "\n";'
      r ← ExecSQL sql
    ∇

    ∇ r←ExecSQL sql;file
      file ← '/var/lib/mysql-files/coco/zipcode.csv'
      ⎕SH 'sudo rm -f ',file
      (⊂sql) ⎕NPUT '/tmp/run.sql' 1
      ⎕SH 'mysql --defaults-extra-file=/home/coco/.my.cnf zipcode_db < /tmp/run.sql'
      r ← '#out' Replace RenderTable file
    ∇

    ∇ html←RenderTable file;data;i;addr;zip
      :If 0=⎕NEXISTS file ⋄ html ← '結果なし' ⋄ :Return ⋄ :EndIf
      :Trap 0
          data ← ⎕CSV file
          html ← '<table width="100%">'
          :For i :In ⍳⍴data[;1]
              addr ← ∊data[i;2 3 4]
              zip ← ∊data[i;1]
              :If 7=⍴zip ⋄ zip ← (3↑zip),'-',(3↓zip) ⋄ :EndIf
              html ,← '<tr>'
              html ,← '<td style="padding:10px; border-bottom:1px solid #eee; width:120px;"><b>〒',zip,'</b></td>'
              html ,← '<td style="padding:10px; border-bottom:1px solid #eee;">',addr,'</td>'
              html ,← '<td style="padding:10px; border-bottom:1px solid #eee; text-align:right; width:150px;">'
              html ,← '<button style="background:#ea4335;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;" onclick="openMap(''',addr,''')">MAP</button> '
              html ,← '<button style="background:#10a37f;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;" onclick="askAI(''',addr,''')">AI</button>'
              html ,← '</td></tr>'
          :EndFor
          html ,← '</table>'
      :Else
          html ← 'CSVエラー'
      :EndTrap
    ∇

:EndClass
